[TOC]

# 认证、授权

## Authentication  认证信息接口

Spring Security 认证信息主要有 Authentication 实现类来保存，接口定义如下：

```java
public interface Authentication extends Principal, Serializable {

	Collection<? extends GrantedAuthority> getAuthorities();

	Object getCredentials();

	Object getDetails();

	Object getPrincipal();

	boolean isAuthenticated();

}
```

它们各自的功能作用：

- getAuthorities：获取用户的权限
- getCredentials：获取用户凭证，一般来说就是密码
- getDetails：获取用户携带的详细信息
- getPrincipal：获取当前用户，可能是用户名，也可以是用户对象
- isAuthenticated：当前用户是否认证成功



## AuthenticationManager 认证管理接口

Spring Security 的认证工作主要由 AuthenticationManager 接口来负责，这个接口只有一个方法：

```java
public interface AuthenticationManager {

	Authentication authenticate(Authentication authentication) throws AuthenticationException;

}

```

这个接口由三种不同的返回值，代表着三种情况：

- 返回 Authentication 认证信息对象，表示认证成功
- 抛出 AuthenticationException 异常，表示用户输入了无效的凭证
- 返回 null，表示不能断定

### 主要实现类

#### ProviderManager



## AuthenticationProvider 认证处理接口

AuthenticationProvider 接口与 AuthenticationManager 接口有点类似，前者多了一个 supports 方法，可以判断当前的 Authentication Provider 认证处理实例是否支持对应的 Authentication 类型。 



```java
public interface AuthenticationProvider {

	Authentication authenticate(Authentication authentication) throws AuthenticationException;

	boolean supports(Class<?> authentication);

}
```

这两个方法，authenticate 方法与 AuthenticationManager 的 authenticate 方法作用一样。

- supports，用于判断当前 Authentication Provider 是否支持对应的 Authentication 认证类型



## AccessDecisionManager：授权决策器



## AccessDecisionVoter：授权投票器



## UserDetails：规范化用户对象接口

```java
public interface UserDetails extends Serializable {

	Collection<? extends GrantedAuthority> getAuthorities();

	String getPassword();

	String getUsername();

	boolean isAccountNonExpired();

	boolean isAccountNonLocked();

	boolean isCredentialsNonExpired();

	boolean isEnabled();

}
```

接口方法不多，一共 7 个：

- getAuthorities：返回当前账户所具备的权限
- getPassword：返回当前账户的密码
- getUsername：返回当前账户的用户名
- isAccountNonExpired：返回当前账户是否未过期
- isAccountNonLocked：返回当前账户是否未锁定
- isCredentialsNonExpired：返回当前账户凭证（如密码）是否未过期
- isEnabled：返回当前账户是否可用



## UserDetailsService：提供用户数据的接口

这个接口只有一个方法，就是根据用户名称获取用户数据。

```java
public interface UserDetailsService {

	UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;

}
```

- loadUserByUsername：根据用户名查询用户数据



### 主要扩展接口

#### UserDetailsManager：增加增删改查四个方法，以及查询用户是否存在方法

```java
public interface UserDetailsManager extends UserDetailsService {

	void createUser(UserDetails user);

	void updateUser(UserDetails user);

	void deleteUser(String username);

	void changePassword(String oldPassword, String newPassword);

	boolean userExists(String username);
}
```



### 主要实现类

#### JdbcDaoImpl

在 UserDetailsService 基础上，通过 spring-jdbc 实现了从数据库中查询用户的方法

#### ImMemoryUserDetailsManager

实现了 UserDetailsManager 中关于用户的增删改查方法，这些都是基于内存的操作，数据没有持久化

#### JdbcUserDetailsManager 

继承自 JdbcDaoImpl，同时又实现了 UserDetailsManager 接口，除了增删改查之外，这些操作都会持久化到数据库中。不过这个实现类的局限性在于 SQL 都是实现写好的，缺少灵活性，这个类用的不多。

#### CachingUserDetailsService

特点就是会将用户数据缓存起来

#### UserDetailsServiceDelegator

提供了 UserDetailsService 的懒加载功能

#### ReactiveUserDetailsServiceAdapter

webflux-web-security 模块定义的 UserDetailsService 实现的。



# 权限配置

## WebSecurityConfigurer：Web 安全配置接口

### 主要实现类

#### WebSecurityConfigurerAdapter：Web 安全配置基类





